<!doctype html>
<html lang="zh-CN" data-theme="white">
  <head>
    <meta charset="utf-8">
    <title>å®‰å…¨èŠå¤©å®¤</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/chat.css') }}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  </head>
  <body>
    <div class="chat-layout">
      <!-- ä¾§è¾¹æ  -->
      <aside class="sidebar">
        <div class="sidebar-header">
          <div class="sidebar-title">å®‰å…¨èŠå¤©å®¤</div>
          <div class="current-user">æˆ‘ï¼š{{ username }}</div>
        </div>
        
        <div class="sidebar-section">
          <div class="section-title">åœ¨çº¿ç”¨æˆ·</div>
          <ul id="user-list" class="user-list"></ul>
        </div>
        
        <div class="sidebar-section">
          <div class="section-title">ç§äººèŠå¤©</div>
          <ul id="private-chats-list" class="private-chats-list"></ul>
        </div>
        
        <div class="sidebar-section">
          <div class="section-title">æˆ‘çš„èŠå¤©å®¤</div>
          <ul id="user-rooms-list" class="room-list"></ul>
        </div>
        
        <div class="sidebar-section">
          <div class="section-title">æ‰€æœ‰èŠå¤©å®¤</div>
          <ul id="all-rooms-list" class="room-list"></ul>
        </div>
        
        <div class="sidebar-footer">
          <a href="{{ url_for('dashboard') }}" class="sidebar-link">å›åˆ°ä»ªè¡¨ç›˜</a>
          <a href="{{ url_for('logout') }}" class="sidebar-link">é€€å‡ºç™»å½•</a>
          <button class="theme-toggle-btn" id="theme-toggle-btn" title="åˆ‡æ¢ä¸»é¢˜">ğŸ¨</button>
          
          <!-- ä¸»é¢˜é€‰æ‹©é¢æ¿ -->
          <div class="theme-panel" id="theme-panel">
            <div class="theme-option" data-theme="gray">
              <div class="theme-color-preview" style="background: #6C757D;"></div>
              <span class="theme-name">ç´ é›…ç°</span>
            </div>
            <div class="theme-option" data-theme="white">
              <div class="theme-color-preview" style="background: #333333;"></div>
              <span class="theme-name">æç®€ç™½</span>
            </div>
            <div class="theme-option" data-theme="yellow">
              <div class="theme-color-preview" style="background: #FFC107;"></div>
              <span class="theme-name">ç››å¤é»„</span>
            </div>
            <div class="theme-option" data-theme="pink">
              <div class="theme-color-preview" style="background: #FF69B4;"></div>
              <span class="theme-name">æ¡ƒæ¡ƒç²‰</span>
            </div>
            <div class="theme-option" data-theme="blue">
              <div class="theme-color-preview" style="background: #2D7DD2;"></div>
              <span class="theme-name">ç»å…¸è“</span>
            </div>
            <div class="theme-option" data-theme="black">
              <div class="theme-color-preview" style="background: #E0E0E0;"></div>
              <span class="theme-name">æè‡´é»‘</span>
            </div>
          </div>
        </div>
      </aside>

      <!-- ä¸»èŠå¤©åŒºåŸŸ -->
      <main class="chat-main">
        <header class="chat-header">
          <div class="current-room-info">
            <div class="room-icon" id="current-room-icon">G</div>
            <div class="room-details">
              <h2 id="current-room-title">å®‰å…¨èŠå¤©å®¤</h2>
              <p id="current-room-subtitle">å½“å‰èŠå¤©å®¤: general</p>
            </div>
          </div>
          <div class="chat-actions">
            <button class="action-btn" onclick="switchRoom('general')">é»˜è®¤èŠå¤©å®¤</button>
            <button class="action-btn" onclick="window.location.href='{{ url_for('dashboard') }}'">ç®¡ç†èŠå¤©å®¤</button>
          </div>
        </header>

        <section class="messages-container">
          <div class="chat-inner-frame" id="chat-inner-frame">
            <div class="messages" id="messages">
              {% for msg in history %}
                <div class="message {% if msg.user == username %}message-own{% else %}message-other{% endif %}">
                  <div class="message-inner">
                    <div class="message-avatar">{{ msg.user[0]|upper }}</div>
                    <div class="message-content">
                      <div class="message-header">
                        <span class="message-username">{{ msg.user }}</span>
                        <span class="message-time">{{ msg.time }}</span>
                      </div>
                      <div class="message-text">{{ msg.text }}</div>
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        </section>

        <div class="chat-input-area">
          <div id="private-chat-indicator" class="private-chat-indicator">
            <div class="private-chat-info">
              <span class="private-chat-label">ç§äººèŠå¤©:</span>
              <span class="private-chat-partner" id="private-chat-partner"></span>
            </div>
            <button class="exit-private-btn" id="exit-private-chat">é€€å‡ºç§äººèŠå¤©</button>
          </div>
          
          <div class="message-input-wrapper">
            <div class="input-toolbar">
              <button class="toolbar-btn" id="emoji-btn" title="è¡¨æƒ…">ğŸ˜Š</button>
            </div>
            <!-- è¡¨æƒ…é¢æ¿æ”¾åœ¨è¾“å…¥åŒºåŸŸå†…ï¼Œä¿è¯å®šä½å‚ç…§ -->
            <div class="emoji-panel" id="emoji-panel">
              <div class="emoji-item">ğŸ˜€</div>
              <div class="emoji-item">ğŸ˜ƒ</div>
              <div class="emoji-item">ğŸ˜„</div>
              <div class="emoji-item">ğŸ˜</div>
              <div class="emoji-item">ğŸ˜†</div>
              <div class="emoji-item">ğŸ˜…</div>
              <div class="emoji-item">ğŸ˜‚</div>
              <div class="emoji-item">ğŸ¤£</div>
              <div class="emoji-item">ğŸ˜Š</div>
              <div class="emoji-item">ğŸ˜‡</div>
              <div class="emoji-item">ğŸ™‚</div>
              <div class="emoji-item">ğŸ™ƒ</div>
              <div class="emoji-item">ğŸ˜‰</div>
              <div class="emoji-item">ğŸ˜Œ</div>
              <div class="emoji-item">ğŸ˜</div>
              <div class="emoji-item">ğŸ¥°</div>
              <div class="emoji-item">ğŸ˜˜</div>
              <div class="emoji-item">ğŸ˜—</div>
              <div class="emoji-item">ğŸ˜™</div>
              <div class="emoji-item">ğŸ˜š</div>
              <div class="emoji-item">ğŸ˜‹</div>
              <div class="emoji-item">ğŸ˜›</div>
              <div class="emoji-item">ğŸ˜</div>
              <div class="emoji-item">ğŸ˜œ</div>
              <div class="emoji-item">ğŸ¤ª</div>
              <div class="emoji-item">ğŸ¤¨</div>
              <div class="emoji-item">ğŸ§</div>
              <div class="emoji-item">ğŸ¤“</div>
              <div class="emoji-item">ğŸ˜</div>
              <div class="emoji-item">ğŸ¤©</div>
              <div class="emoji-item">ğŸ¥³</div>
              <div class="emoji-item">ğŸ˜</div>
              <div class="emoji-item">ğŸ˜’</div>
              <div class="emoji-item">ğŸ˜</div>
              <div class="emoji-item">ğŸ˜”</div>
              <div class="emoji-item">ğŸ˜Ÿ</div>
              <div class="emoji-item">ğŸ˜•</div>
              <div class="emoji-item">ğŸ™</div>
              <div class="emoji-item">â˜¹ï¸</div>
              <div class="emoji-item">ğŸ˜£</div>
              <div class="emoji-item">ğŸ˜–</div>
              <div class="emoji-item">ğŸ˜«</div>
              <div class="emoji-item">ğŸ˜©</div>
              <div class="emoji-item">ğŸ¥º</div>
              <div class="emoji-item">ğŸ˜¢</div>
              <div class="emoji-item">ğŸ˜­</div>
              <div class="emoji-item">ğŸ˜¤</div>
              <div class="emoji-item">ğŸ˜ </div>
              <div class="emoji-item">ğŸ˜¡</div>
              <div class="emoji-item">ğŸ¤¬</div>
              <div class="emoji-item">ğŸ¤¯</div>
              <div class="emoji-item">ğŸ˜³</div>
              <div class="emoji-item">ğŸ¥µ</div>
              <div class="emoji-item">ğŸ¥¶</div>
              <div class="emoji-item">ğŸ˜±</div>
              <div class="emoji-item">ğŸ˜¨</div>
              <div class="emoji-item">ğŸ˜°</div>
              <div class="emoji-item">ğŸ˜¥</div>
              <div class="emoji-item">ğŸ˜“</div>
              <div class="emoji-item">ğŸ¤—</div>
              <div class="emoji-item">ğŸ¤”</div>
              <div class="emoji-item">ğŸ¤­</div>
              <div class="emoji-item">ğŸ¤«</div>
              <div class="emoji-item">ğŸ¤¥</div>
              <div class="emoji-item">ğŸ˜¶</div>
              <div class="emoji-item">ğŸ˜</div>
              <div class="emoji-item">ğŸ˜‘</div>
              <div class="emoji-item">ğŸ˜¬</div>
              <div class="emoji-item">ğŸ™„</div>
              <div class="emoji-item">ğŸ˜¯</div>
              <div class="emoji-item">ğŸ˜¦</div>
              <div class="emoji-item">ğŸ˜§</div>
              <div class="emoji-item">ğŸ˜®</div>
              <div class="emoji-item">ğŸ˜²</div>
              <div class="emoji-item">ğŸ¥±</div>
              <div class="emoji-item">ğŸ˜´</div>
              <div class="emoji-item">ğŸ¤¤</div>
              <div class="emoji-item">ğŸ˜ª</div>
              <div class="emoji-item">ğŸ˜µ</div>
              <div class="emoji-item">ğŸ¤</div>
              <div class="emoji-item">ğŸ¥´</div>
              <div class="emoji-item">ğŸ¤¢</div>
              <div class="emoji-item">ğŸ¤®</div>
              <div class="emoji-item">ğŸ¤§</div>
              <div class="emoji-item">ğŸ˜·</div>
              <div class="emoji-item">ğŸ¤’</div>
              <div class="emoji-item">ğŸ¤•</div>
              <div class="emoji-item">ğŸ¤‘</div>
              <div class="emoji-item">ğŸ¤ </div>
              <div class="emoji-item">ğŸ˜ˆ</div>
              <div class="emoji-item">ğŸ‘¿</div>
              <div class="emoji-item">ğŸ‘¹</div>
              <div class="emoji-item">ğŸ‘º</div>
              <div class="emoji-item">ğŸ¤¡</div>
              <div class="emoji-item">ğŸ’©</div>
              <div class="emoji-item">ğŸ‘»</div>
              <div class="emoji-item">ğŸ’€</div>
              <div class="emoji-item">â˜ ï¸</div>
              <div class="emoji-item">ğŸ‘½</div>
              <div class="emoji-item">ğŸ‘¾</div>
              <div class="emoji-item">ğŸ¤–</div>
              <div class="emoji-item">ğŸƒ</div>
              <div class="emoji-item">ğŸ˜º</div>
              <div class="emoji-item">ğŸ˜¸</div>
              <div class="emoji-item">ğŸ˜¹</div>
              <div class="emoji-item">ğŸ˜»</div>
              <div class="emoji-item">ğŸ˜¼</div>
              <div class="emoji-item">ğŸ˜½</div>
              <div class="emoji-item">ğŸ™€</div>
              <div class="emoji-item">ğŸ˜¿</div>
              <div class="emoji-item">ğŸ˜¾</div>
            </div>
            <form id="chat-form" class="message-form">
              <textarea 
                id="msg-input" 
                class="message-input" 
                placeholder="è¾“å…¥æ¶ˆæ¯..." 
                rows="1"
                autocomplete="off"
              ></textarea>
              <button type="submit" class="send-btn" id="send-btn" title="å‘é€">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                </svg>
              </button>
            </form>
          </div>
        </div>
      </main>
    </div>

    <!-- Socket.IO å®¢æˆ·ç«¯ -->
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
      // ä¸åç«¯å»ºç«‹ Socket.IO è¿æ¥
      const socket = io({
        transports: ["websocket"]
      });

      // è·å–DOMå…ƒç´ 
      const messagesEl = document.getElementById("messages");
      const msgInput = document.getElementById("msg-input");
      const chatForm = document.getElementById("chat-form");
      const userListEl = document.getElementById("user-list");
      const privateChatsListEl = document.getElementById("private-chats-list");
      const userRoomsListEl = document.getElementById("user-rooms-list");
      const allRoomsListEl = document.getElementById("all-rooms-list");
      const privateChatIndicator = document.getElementById("private-chat-indicator");
      const privateChatPartner = document.getElementById("private-chat-partner");
      const exitPrivateChatBtn = document.getElementById("exit-private-chat");
      const currentRoomIcon = document.getElementById("current-room-icon");
      const currentRoomTitle = document.getElementById("current-room-title");
      const currentRoomSubtitle = document.getElementById("current-room-subtitle");
      const chatInnerFrame = document.getElementById("chat-inner-frame");
      const themeToggleBtn = document.getElementById("theme-toggle-btn");
      const themePanel = document.getElementById("theme-panel");
      const emojiBtn = document.getElementById("emoji-btn");
      const emojiPanel = document.getElementById("emoji-panel");

      // ä»sessionStorageè·å–å½“å‰æˆ¿é—´å’Œç§èŠä¿¡æ¯
      let currentRoom = sessionStorage.getItem('currentRoom') || 'general';
      let currentPrivateChat = sessionStorage.getItem('privateChat') || null;

      // ä¸»é¢˜ç³»ç»Ÿ
      const themes = {
        'gray': 'ç´ é›…ç°',
        'white': 'æç®€ç™½',
        'yellow': 'ç››å¤é»„',
        'pink': 'æ¡ƒæ¡ƒç²‰',
        'blue': 'ç»å…¸è“',
        'black': 'æè‡´é»‘'
      };

      // åŠ è½½ä¿å­˜çš„ä¸»é¢˜
      const savedTheme = localStorage.getItem('chat-theme') || 'white';
      document.documentElement.setAttribute('data-theme', savedTheme);

      // ä¸»é¢˜åˆ‡æ¢
      if (themeToggleBtn && themePanel) {
        themeToggleBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          themePanel.classList.toggle('active');
        });

        // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­ä¸»é¢˜é¢æ¿
        document.addEventListener('click', function(e) {
          if (themePanel && themeToggleBtn) {
            if (!themePanel.contains(e.target) && !themeToggleBtn.contains(e.target)) {
              themePanel.classList.remove('active');
            }
          }
        });

        // é€‰æ‹©ä¸»é¢˜
        document.querySelectorAll('.theme-option').forEach(option => {
          option.addEventListener('click', function(e) {
            e.stopPropagation();
            const theme = this.getAttribute('data-theme');
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('chat-theme', theme);
            if (themePanel) {
              themePanel.classList.remove('active');
            }
          });
        });
      } else {
        console.error('ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½åˆå§‹åŒ–å¤±è´¥ï¼šæ‰¾ä¸åˆ°å¿…è¦çš„DOMå…ƒç´ ');
      }

      // è¡¨æƒ…é¢æ¿åŠŸèƒ½
      if (emojiBtn && emojiPanel) {
        emojiBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          emojiPanel.classList.toggle('active');
        });

        // ç‚¹å‡»è¡¨æƒ…æ’å…¥åˆ°è¾“å…¥æ¡†
        document.querySelectorAll('.emoji-item').forEach(item => {
          item.addEventListener('click', function() {
            const emoji = this.textContent;
            msgInput.value += emoji;
            msgInput.focus();
            adjustTextareaHeight();
          });
        });

        // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­è¡¨æƒ…é¢æ¿
        document.addEventListener('click', function(e) {
          if (!emojiPanel.contains(e.target) && !emojiBtn.contains(e.target)) {
            emojiPanel.classList.remove('active');
          }
        });
      }

      // åˆå§‹åŒ–é¡µé¢çŠ¶æ€
      updateRoomDisplay();
      updatePrivateChatIndicator();

      // è‡ªåŠ¨æ»šåŠ¨åˆ°æ¶ˆæ¯åº•éƒ¨
      function scrollToBottom() {
        chatInnerFrame.scrollTo({
          top: chatInnerFrame.scrollHeight,
          behavior: 'smooth'
        });
      }

      // æ›´æ–°æˆ¿é—´æ˜¾ç¤º
      function updateRoomDisplay() {
        if (currentPrivateChat) {
          currentRoomIcon.textContent = currentPrivateChat[0].toUpperCase();
          currentRoomTitle.textContent = `ç§äººèŠå¤© - ${currentPrivateChat}`;
          currentRoomSubtitle.textContent = "ç«¯åˆ°ç«¯åŠ å¯†å¯¹è¯";
        } else {
          currentRoomIcon.textContent = currentRoom[0].toUpperCase();
          currentRoomTitle.textContent = "å®‰å…¨èŠå¤©å®¤";
          currentRoomSubtitle.textContent = `å½“å‰èŠå¤©å®¤: ${currentRoom}`;
        }
      }

      // æ›´æ–°ç§äººèŠå¤©æŒ‡ç¤ºå™¨
      function updatePrivateChatIndicator() {
        if (currentPrivateChat) {
          privateChatIndicator.classList.add('active');
          privateChatPartner.textContent = currentPrivateChat;
        } else {
          privateChatIndicator.classList.remove('active');
        }
      }

      // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
      function addMessage(msg, isSystem = false) {
        if (isSystem) {
          const systemMsg = document.createElement("div");
          systemMsg.className = "system-message";
          systemMsg.innerHTML = `<div class="system-text">${msg.text}</div>`;
          messagesEl.appendChild(systemMsg);
        } else {
          const messageDiv = document.createElement("div");
          const isOwnMessage = msg.user === "{{ username }}";
          
          // æ ¹æ®æ¶ˆæ¯å‘é€è€…å†³å®šæ ·å¼ç±»
          messageDiv.className = `message ${isOwnMessage ? 'message-own' : 'message-other'}`;
          
          messageDiv.innerHTML = `
            <div class="message-inner">
              <div class="message-avatar">${msg.user[0].toUpperCase()}</div>
              <div class="message-content">
                <div class="message-header">
                  <span class="message-username">${msg.user}</span>
                  <span class="message-time">${msg.time}</span>
                </div>
                <div class="message-text">${msg.text}</div>
              </div>
            </div>
          `;
          
          messagesEl.appendChild(messageDiv);
        }
        
        scrollToBottom();
      }

      // å‘é€æ¶ˆæ¯
      function sendMessage(text) {
        if (!text || !text.trim()) return;

        if (currentPrivateChat) {
          // å‘é€ç§äººæ¶ˆæ¯
          socket.emit("private_message", {
            to_user: currentPrivateChat,
            text: text.trim()
          });
        } else {
          // å‘é€èŠå¤©å®¤æ¶ˆæ¯
          socket.emit("chat_message", {
            text: text.trim(),
            room: currentRoom
          });
        }

        msgInput.value = "";
        adjustTextareaHeight();
      }

      // è°ƒæ•´æ–‡æœ¬åŒºåŸŸé«˜åº¦
      function adjustTextareaHeight() {
        msgInput.style.height = 'auto';
        msgInput.style.height = Math.min(msgInput.scrollHeight, 120) + 'px';
      }

      // åˆ‡æ¢èŠå¤©å®¤
      function switchRoom(roomName) {
        socket.emit('switch_room', { room_name: roomName });
        currentRoom = roomName;
        currentPrivateChat = null;
        sessionStorage.setItem('currentRoom', roomName);
        sessionStorage.removeItem('privateChat');
        updateRoomDisplay();
        updatePrivateChatIndicator();
        messagesEl.innerHTML = ''; // æ¸…ç©ºæ¶ˆæ¯æ˜¾ç¤º
      }

      // å¼€å§‹ç§äººèŠå¤©
      function startPrivateChat(username) {
        currentPrivateChat = username;
        currentRoom = 'general'; // é‡ç½®ä¸ºé»˜è®¤æˆ¿é—´ï¼Œä½†æ˜¾ç¤ºç§äººèŠå¤©
        sessionStorage.setItem('privateChat', username);
        sessionStorage.removeItem('currentRoom');
        updateRoomDisplay();
        updatePrivateChatIndicator();
        messagesEl.innerHTML = ''; // æ¸…ç©ºæ¶ˆæ¯æ˜¾ç¤º
        
        // åŠ è½½ç§äººæ¶ˆæ¯å†å²
        socket.emit('load_private_history', { other_user: username });
      }

      // é€€å‡ºç§äººèŠå¤©
      function exitPrivateChat() {
        currentPrivateChat = null;
        sessionStorage.removeItem('privateChat');
        updateRoomDisplay();
        updatePrivateChatIndicator();
        messagesEl.innerHTML = ''; // æ¸…ç©ºæ¶ˆæ¯æ˜¾ç¤º
        
        // åŠ è½½å½“å‰æˆ¿é—´çš„å†å²
        socket.emit('switch_room', { room_name: currentRoom });
      }

      // äº‹ä»¶ç›‘å¬å™¨
      chatForm.addEventListener("submit", function (e) {
        e.preventDefault();
        sendMessage(msgInput.value);
      });

      msgInput.addEventListener("input", adjustTextareaHeight);

      msgInput.addEventListener("keydown", function (e) {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage(msgInput.value);
        }
      });

      exitPrivateChatBtn.addEventListener("click", exitPrivateChat);

      // Socket.IO äº‹ä»¶å¤„ç†
      socket.on("connect", function () {
        console.log("å·²è¿æ¥åˆ°æœåŠ¡å™¨");
        
        // å¦‚æœå½“å‰åœ¨ç§äººèŠå¤©æ¨¡å¼ï¼ŒåŠ è½½å†å²
        if (currentPrivateChat) {
          socket.emit('load_private_history', { other_user: currentPrivateChat });
        }
      });

      socket.on("chat_message", function (msg) {
        // åªåœ¨å½“å‰æˆ¿é—´æ˜¾ç¤ºæ¶ˆæ¯ï¼ˆéç§äººèŠå¤©æ¨¡å¼ï¼‰
        if (!currentPrivateChat && msg.room === currentRoom) {
          addMessage(msg);
        }
      });

      socket.on("private_message", function (msg) {
        console.log("æ”¶åˆ°ç§äººæ¶ˆæ¯:", msg);
        // å¦‚æœå½“å‰æ­£åœ¨ä¸å‘é€è€…æˆ–æ¥æ”¶è€…è¿›è¡Œç§äººèŠå¤©ï¼Œæ˜¾ç¤ºæ¶ˆæ¯
        if (currentPrivateChat) {
          // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦ä¸å½“å‰ç§äººèŠå¤©ç›¸å…³
          const isRelevantMessage = 
            (msg.from_user === currentPrivateChat && msg.to_user === "{{ username }}") ||
            (msg.to_user === currentPrivateChat && msg.from_user === "{{ username }}");
          
          if (isRelevantMessage) {
            // ç¡®ä¿æ¶ˆæ¯å¯¹è±¡æœ‰æ­£ç¡®çš„ç”¨æˆ·å­—æ®µ
            const displayMsg = {
              user: msg.from_user,
              text: msg.text,
              time: msg.time
            };
            addMessage(displayMsg);
          }
        }
      });

      socket.on("system_message", function (data) {
        addMessage(data, true);
      });

      socket.on("online_users", function (users) {
        userListEl.innerHTML = "";
        users.forEach(function (username) {
          if (username !== "{{ username }}") {
            const userItem = document.createElement("li");
            userItem.className = "user-item";
            userItem.innerHTML = `
              <div class="user-avatar">${username[0].toUpperCase()}</div>
              <div class="user-name">${username}</div>
              <div class="user-status"></div>
            `;
            userItem.addEventListener("click", function() {
              startPrivateChat(username);
            });
            userListEl.appendChild(userItem);
          }
        });
      });

      socket.on("private_chats_list", function (chats) {
        privateChatsListEl.innerHTML = "";
        chats.forEach(function (chat) {
          const chatItem = document.createElement("li");
          chatItem.className = "private-chat-item";
          chatItem.innerHTML = `
            <div class="user-avatar">${chat.partner[0].toUpperCase()}</div>
            <div class="private-chat-name">${chat.partner}</div>
          `;
          chatItem.addEventListener("click", function() {
            startPrivateChat(chat.partner);
          });
          privateChatsListEl.appendChild(chatItem);
        });
      });

      socket.on("user_rooms_list", function (rooms) {
        userRoomsListEl.innerHTML = "";
        rooms.forEach(function (roomName) {
          const roomItem = document.createElement("li");
          roomItem.className = "room-item";
          roomItem.innerHTML = `
            <div class="user-avatar">${roomName[0].toUpperCase()}</div>
            <div class="room-name">${roomName}</div>
          `;
          roomItem.addEventListener("click", function() {
            switchRoom(roomName);
          });
          userRoomsListEl.appendChild(roomItem);
        });
      });

      socket.on("all_rooms_list", function (rooms) {
        allRoomsListEl.innerHTML = "";
        rooms.forEach(function (room) {
          const roomItem = document.createElement("li");
          roomItem.className = "room-item";
          roomItem.innerHTML = `
            <div class="user-avatar">${room.name[0].toUpperCase()}</div>
            <div class="room-name">${room.name}</div>
          `;
          roomItem.addEventListener("click", function() {
            switchRoom(room.name);
          });
          allRoomsListEl.appendChild(roomItem);
        });
      });

      socket.on("room_history", function (data) {
        // åªåœ¨éç§äººèŠå¤©æ¨¡å¼ä¸”æˆ¿é—´åŒ¹é…æ—¶æ˜¾ç¤ºå†å²
        if (!currentPrivateChat && data.room === currentRoom) {
          messagesEl.innerHTML = "";
          data.history.forEach(function (msg) {
            addMessage(msg);
          });
        }
      });

      socket.on("private_history", function (data) {
        if (currentPrivateChat === data.other_user) {
          messagesEl.innerHTML = "";
          data.history.forEach(function (msg) {
            addMessage(msg);
          });
        }
      });

      // åˆå§‹åŒ–æ–‡æœ¬åŒºåŸŸé«˜åº¦
      adjustTextareaHeight();
      
      // åˆå§‹æ»šåŠ¨åˆ°åº•éƒ¨
      scrollToBottom();
    </script>
  </body>
</html>
