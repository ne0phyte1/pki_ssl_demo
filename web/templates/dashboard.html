<!doctype html>
<html lang="zh-CN" data-theme="white">
  <head>
    <meta charset="utf-8">
    <title>èŠå¤©ä»ªè¡¨ç›˜ - å®‰å…¨é€šè®¯ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}">
    <style>
      .dashboard-layout {
        min-height: 100vh;
        background: var(--theme-bg);
        padding: 1rem;
      }
      
      .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        padding: 1rem 0;
      }
      
      .dashboard-title {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--theme-text-primary);
        margin: 0;
      }
      
      .user-info {
        display: flex;
        align-items: center;
        gap: 1rem;
        color: var(--theme-text-primary);
      }
      
      .logout-btn {
        background: var(--theme-secondary);
        color: var(--theme-text-primary);
        padding: 0.5rem 1rem;
        border-radius: 8px;
        text-decoration: none;
        transition: opacity 100ms ease;
        border: 1px solid var(--theme-border);
      }
      
      .logout-btn:hover {
        opacity: 0.8;
      }
      
      .theme-toggle-btn {
        background: var(--theme-secondary);
        border: 1px solid var(--theme-border);
        color: var(--theme-text-primary);
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        transition: opacity 100ms ease;
        margin-left: 0.5rem;
      }
      
      .theme-toggle-btn:hover {
        opacity: 0.8;
      }
      
      .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
        gap: 2rem;
        margin-bottom: 2rem;
      }
      
      .dashboard-card {
        background: var(--theme-card-bg);
        border-radius: 16px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border: 1px solid var(--theme-border);
        padding: 1.75rem;
        transition: transform 100ms ease;
        position: relative;
        overflow: hidden;
      }
      
      .dashboard-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: var(--theme-primary);
      }
      
      .dashboard-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
      }
      
      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--theme-border);
      }
      
      .card-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--theme-text-primary);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }
      
      .card-title::before {
        content: '';
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: var(--theme-primary);
      }
      
      .quick-actions {
        display: flex;
        gap: 0.5rem;
      }
      
      .action-btn {
        background: var(--theme-primary);
        color: var(--theme-bg);
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-size: 0.75rem;
        cursor: pointer;
        transition: opacity 100ms ease;
        font-weight: 600;
      }
      
      .action-btn:hover {
        opacity: 0.9;
      }
      
      .room-list, .user-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }
      
      .room-item, .user-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        background: var(--theme-secondary);
        border-radius: 12px;
        border: 1px solid var(--theme-border);
        transition: background-color 100ms ease;
      }
      
      .room-item:hover, .user-item:hover {
        background: var(--theme-border);
      }
      
      .room-info, .user-info-compact {
        flex: 1;
      }
      
      .room-name, .user-name {
        font-weight: 600;
        color: var(--theme-text-primary);
        margin-bottom: 0.25rem;
        font-size: 0.9rem;
      }
      
      .room-meta, .user-meta {
        font-size: 0.7rem;
        color: var(--theme-text-secondary);
        opacity: 0.8;
      }
      
      .enter-btn, .join-btn, .chat-btn {
        background: var(--theme-primary);
        color: var(--theme-bg);
        padding: 0.5rem 1rem;
        border-radius: 8px;
        text-decoration: none;
        font-size: 0.75rem;
        transition: opacity 100ms ease;
        border: none;
        cursor: pointer;
        font-weight: 600;
      }
      
      .enter-btn:hover, .join-btn:hover, .chat-btn:hover {
        opacity: 0.9;
      }
      
      .history-controls {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        margin-bottom: 1rem;
      }
      
      .history-filter-row {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }
      
      .history-filter-row label {
        font-size: 0.75rem;
        color: var(--theme-text-secondary);
      }
      
      .history-control-input {
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--theme-border);
        border-radius: 8px;
        background: var(--theme-bg);
        color: var(--theme-text-primary);
        font-size: 0.85rem;
      }
      
      .history-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        max-height: 320px;
        overflow-y: auto;
      }
      
      .history-item {
        padding: 0.75rem;
        border-radius: 10px;
        border: 1px solid var(--theme-border);
        background: var(--theme-secondary);
        position: relative;
      }
      
      .history-item strong {
        display: block;
        margin-bottom: 0.25rem;
        color: var(--theme-text-primary);
      }
      
      .history-meta {
        font-size: 0.75rem;
        color: var(--theme-text-secondary);
        margin-bottom: 0.25rem;
      }
      
      .history-text {
        font-size: 0.85rem;
        color: var(--theme-text-primary);
        line-height: 1.4;
        white-space: pre-wrap;
      }
      
      .history-delete-btn {
        position: absolute;
        top: 8px;
        right: 8px;
        border: none;
        background: transparent;
        color: var(--danger-color, #d9534f);
        cursor: pointer;
        font-size: 0.8rem;
      }
      
      .history-empty,
      .history-loading {
        text-align: center;
        padding: 2rem 0;
        color: var(--theme-text-secondary);
        font-size: 0.85rem;
      }
      
      .join-btn {
        background: var(--online-status);
      }
      
      .user-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: var(--theme-primary);
        color: var(--theme-bg);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        margin-right: 0.75rem;
        font-size: 0.8rem;
      }
      
      .empty-state {
        text-align: center;
        padding: 2.5rem 1rem;
        color: var(--theme-text-secondary);
        font-size: 0.9rem;
      }
      
      .empty-state::before {
        content: 'ğŸ“';
        font-size: 2rem;
        display: block;
        margin-bottom: 0.5rem;
        opacity: 0.5;
      }
      
      .create-room-section {
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 1px solid rgba(0, 0, 0, 0.08);
      }
      
      .create-room-btn {
        width: 100%;
        background: transparent;
        border: 2px dashed var(--theme-primary);
        color: var(--theme-primary);
        padding: 1rem;
        border-radius: 12px;
        cursor: pointer;
        transition: opacity 100ms ease, background-color 100ms ease, color 100ms ease;
        font-weight: 700;
        font-size: 0.9rem;
      }
      
      .create-room-btn:hover {
        background: var(--theme-primary);
        color: var(--theme-bg);
      }
      
      /* æ¨¡æ€æ¡†æ ·å¼ */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }
      
      .modal-content {
        background: var(--theme-card-bg);
        border-radius: 16px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        border: 1px solid var(--theme-border);
        padding: 2rem;
        max-width: 400px;
        width: 90%;
        position: relative;
      }
      
      .modal-close {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--theme-text-secondary);
      }
      
      .modal-title {
        margin-bottom: 1.5rem;
        color: var(--theme-text-primary);
      }
      
      .modal-form {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      
      .modal-input {
        padding: 0.75rem 1rem;
        border: 1px solid var(--theme-border);
        border-radius: 8px;
        font-size: 0.875rem;
        background: var(--theme-bg);
        color: var(--theme-text-primary);
        transition: border-color 100ms ease;
      }
      
      .modal-input:focus {
        outline: none;
        border-color: var(--theme-primary);
        box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.05);
      }
      
      .modal-submit {
        background: var(--theme-primary);
        color: var(--theme-bg);
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: opacity 100ms ease;
      }
      
      .modal-submit:hover {
        opacity: 0.9;
      }
      
      .theme-option:hover {
        background: var(--theme-secondary);
      }
      
      @media (max-width: 768px) {
        .dashboard-grid {
          grid-template-columns: 1fr;
        }
        
        .dashboard-header {
          flex-direction: column;
          gap: 1rem;
          text-align: center;
        }
        
        .room-item, .user-item {
          flex-direction: column;
          gap: 1rem;
          text-align: center;
        }
      }
    </style>
  </head>
  <body>
    <div class="dashboard-layout fade-in">
      <header class="dashboard-header">
        <h1 class="dashboard-title">å®‰å…¨é€šè®¯ç³»ç»Ÿ</h1>
        <div class="user-info">
          <span>æ¬¢è¿ï¼Œ{{ username }}ï¼</span>
          <button class="theme-toggle-btn" id="theme-toggle-btn" title="åˆ‡æ¢ä¸»é¢˜">ğŸ¨</button>
          <a class="logout-btn" href="{{ url_for('logout') }}">é€€å‡ºç™»å½•</a>
        </div>
      </header>

      <div class="dashboard-grid">
        <!-- æˆ‘çš„èŠå¤©å®¤å¡ç‰‡ -->
        <div class="dashboard-card">
          <div class="card-header">
            <h2 class="card-title">æˆ‘çš„èŠå¤©å®¤</h2>
            <div class="quick-actions">
              <button class="action-btn" id="join-by-token-btn">é€šè¿‡TokenåŠ å…¥</button>
              <button class="action-btn" id="manage-rooms-btn">ç®¡ç†èŠå¤©å®¤</button>
            </div>
          </div>
          
          <div class="room-list">
            {% if user_rooms %}
              {% for room_name in user_rooms %}
                <div class="room-item">
                  <div class="room-info">
                    <div class="room-name">{{ room_name }}</div>
                    <div class="room-meta">å·²åŠ å…¥çš„èŠå¤©å®¤</div>
                  </div>
                  <a href="{{ url_for('chat') }}" class="enter-btn" onclick="setCurrentRoom('{{ room_name }}')">è¿›å…¥</a>
                </div>
              {% endfor %}
            {% else %}
              <div class="empty-state">æ‚¨è¿˜æ²¡æœ‰åŠ å…¥ä»»ä½•èŠå¤©å®¤</div>
            {% endif %}
          </div>
          
          <div class="create-room-section">
            <button class="create-room-btn" id="create-room-btn">+ åˆ›å»ºèŠå¤©å®¤</button>
          </div>
        </div>

        <!-- å…¬å…±èŠå¤©å®¤å¡ç‰‡ -->
        <div class="dashboard-card">
          <div class="card-header">
            <h2 class="card-title">å…¬å…±èŠå¤©å®¤</h2>
          </div>
          
          <div class="room-list">
            {% if public_rooms %}
              {% for room in public_rooms %}
                <div class="room-item">
                  <div class="room-info">
                    <div class="room-name">{{ room.name }}</div>
                    <div class="room-meta">
                      åˆ›å»ºè€…: {{ room.created_by }}
                      <br>
                      <small>åˆ›å»ºæ—¶é—´: {{ room.created_at }}</small>
                    </div>
                  </div>
                  {% if room.name in user_rooms %}
                    <a href="{{ url_for('chat') }}" class="enter-btn" onclick="setCurrentRoom('{{ room.name }}')">è¿›å…¥</a>
                  {% else %}
                    <button class="join-btn" onclick="joinRoom('{{ room.name }}')">åŠ å…¥</button>
                  {% endif %}
                </div>
              {% endfor %}
            {% else %}
              <div class="empty-state">æš‚æ— å…¬å…±èŠå¤©å®¤</div>
            {% endif %}
          </div>
        </div>

        <!-- ç”¨æˆ·åˆ—è¡¨å¡ç‰‡ -->
        <div class="dashboard-card">
          <div class="card-header">
            <h2 class="card-title">æ‰€æœ‰ç”¨æˆ·</h2>
          </div>
          
          <div class="user-list">
            {% if other_users %}
              {% for user in other_users %}
                <div class="user-item">
                  <div class="user-info-compact" style="display: flex; align-items: center;">
                    <div class="user-avatar">{{ user[0]|upper }}</div>
                    <div>
                      <div class="user-name">{{ user }}</div>
                      <div class="user-meta">åœ¨çº¿ç”¨æˆ·</div>
                    </div>
                  </div>
                  <a href="{{ url_for('chat') }}" class="chat-btn" onclick="startPrivateChat('{{ user }}')">ç§èŠ</a>
                </div>
              {% endfor %}
            {% else %}
              <div class="empty-state">æš‚æ— å…¶ä»–ç”¨æˆ·</div>
            {% endif %}
          </div>
        </div>

        <!-- èŠå¤©è®°å½•ç®¡ç†å¡ç‰‡ -->
        <div class="dashboard-card" id="history-card">
          <div class="card-header">
            <h2 class="card-title">æˆ‘çš„èŠå¤©è®°å½•</h2>
            <div class="quick-actions">
              <button class="action-btn" id="history-refresh-btn">åˆ·æ–°</button>
            </div>
          </div>
          
          <div class="history-controls">
            <div class="history-filter-row">
              <label for="history-type-select">è®°å½•ç±»å‹</label>
              <select class="history-control-input" id="history-type-select">
                <option value="room">èŠå¤©å®¤</option>
                <option value="private">ç§äººæ¶ˆæ¯</option>
              </select>
            </div>
            <div class="history-filter-row" id="history-room-group">
              <label for="history-room-select">é€‰æ‹©èŠå¤©å®¤</label>
              <select class="history-control-input" id="history-room-select">
                <option value="">å…¨éƒ¨èŠå¤©å®¤</option>
                {% for room_name in user_rooms %}
                  <option value="{{ room_name }}">{{ room_name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="history-filter-row" id="history-partner-group" style="display: none;">
              <label for="history-partner-select">è”ç³»äºº</label>
              <select class="history-control-input" id="history-partner-select">
                <option value="">å…¨éƒ¨è”ç³»äºº</option>
                {% for partner in private_partners %}
                  <option value="{{ partner }}">{{ partner }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="history-filter-row">
              <label for="history-search-input">å…³é”®å­—</label>
              <input 
                type="text" 
                id="history-search-input" 
                class="history-control-input" 
                placeholder="æŒ‰å†…å®¹æœç´¢">
            </div>
          </div>
          
          <div class="history-list" id="history-list">
            <div class="history-empty">æš‚æ— èŠå¤©è®°å½•</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ä¸»é¢˜é€‰æ‹©é¢æ¿ -->
    <div class="theme-panel" id="theme-panel" style="position: fixed; bottom: 20px; right: 20px; background: var(--theme-card-bg); border: 1px solid var(--theme-border); border-radius: 8px; padding: 12px; display: none; flex-direction: column; gap: 8px; z-index: 1000; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); max-width: 200px;">
      <div class="theme-option" data-theme="gray" style="display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 6px; cursor: pointer; transition: background-color 100ms ease;">
        <div style="width: 24px; height: 24px; border-radius: 4px; background: #6C757D; flex-shrink: 0; border: 1px solid var(--theme-border);"></div>
        <span style="font-size: 13px; color: var(--theme-text-primary);">ç´ é›…ç°</span>
      </div>
      <div class="theme-option" data-theme="white" style="display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 6px; cursor: pointer; transition: background-color 100ms ease;">
        <div style="width: 24px; height: 24px; border-radius: 4px; background: #333333; flex-shrink: 0; border: 1px solid var(--theme-border);"></div>
        <span style="font-size: 13px; color: var(--theme-text-primary);">æç®€ç™½</span>
      </div>
      <div class="theme-option" data-theme="yellow" style="display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 6px; cursor: pointer; transition: background-color 100ms ease;">
        <div style="width: 24px; height: 24px; border-radius: 4px; background: #FFC107; flex-shrink: 0; border: 1px solid var(--theme-border);"></div>
        <span style="font-size: 13px; color: var(--theme-text-primary);">ç››å¤é»„</span>
      </div>
      <div class="theme-option" data-theme="pink" style="display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 6px; cursor: pointer; transition: background-color 100ms ease;">
        <div style="width: 24px; height: 24px; border-radius: 4px; background: #FF69B4; flex-shrink: 0; border: 1px solid var(--theme-border);"></div>
        <span style="font-size: 13px; color: var(--theme-text-primary);">æ¡ƒæ¡ƒç²‰</span>
      </div>
      <div class="theme-option" data-theme="blue" style="display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 6px; cursor: pointer; transition: background-color 100ms ease;">
        <div style="width: 24px; height: 24px; border-radius: 4px; background: #2D7DD2; flex-shrink: 0; border: 1px solid var(--theme-border);"></div>
        <span style="font-size: 13px; color: var(--theme-text-primary);">ç»å…¸è“</span>
      </div>
      <div class="theme-option" data-theme="black" style="display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 6px; cursor: pointer; transition: background-color 100ms ease;">
        <div style="width: 24px; height: 24px; border-radius: 4px; background: #E0E0E0; flex-shrink: 0; border: 1px solid var(--theme-border);"></div>
        <span style="font-size: 13px; color: var(--theme-text-primary);">æè‡´é»‘</span>
      </div>
    </div>

    <!-- æ¨¡æ€æ¡† -->
    <div id="create-room-modal" class="modal">
      <div class="modal-content">
        <button class="modal-close">&times;</button>
        <h3 class="modal-title">åˆ›å»ºæ–°èŠå¤©å®¤</h3>
        <form class="modal-form" id="create-room-form">
          <input type="text" class="modal-input" id="room-name-input" placeholder="è¾“å…¥èŠå¤©å®¤åç§°" required>
          <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
            <label style="display: flex; align-items: center; gap: 0.5rem;">
              <input type="radio" name="room-type" value="public" checked>
              å…¬å…±èŠå¤©å®¤
            </label>
            <label style="display: flex; align-items: center; gap: 0.5rem;">
              <input type="radio" name="room-type" value="private">
              ç§æœ‰èŠå¤©å®¤
            </label>
          </div>
          <button type="submit" class="modal-submit">åˆ›å»º</button>
        </form>
      </div>
    </div>

    <div id="join-by-token-modal" class="modal">
      <div class="modal-content">
        <button class="modal-close">&times;</button>
        <h3 class="modal-title">é€šè¿‡TokenåŠ å…¥èŠå¤©å®¤</h3>
        <form class="modal-form" id="join-by-token-form">
          <input type="text" class="modal-input" id="token-input" placeholder="è¾“å…¥èŠå¤©å®¤Token" required>
          <button type="submit" class="modal-submit">åŠ å…¥</button>
        </form>
      </div>
    </div>

    <div id="manage-rooms-modal" class="modal">
      <div class="modal-content">
        <button class="modal-close">&times;</button>
        <h3 class="modal-title">ç®¡ç†æˆ‘çš„èŠå¤©å®¤</h3>
        
        <div class="create-room-section">
          <h4>æˆ‘åˆ›å»ºçš„èŠå¤©å®¤</h4>
          <div id="my-created-rooms-list" class="room-list">
            <!-- åŠ¨æ€åŠ è½½çš„èŠå¤©å®¤åˆ—è¡¨ -->
          </div>
        </div>
      </div>
    </div>

    <!-- Socket.IO å®¢æˆ·ç«¯ -->
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
      // åŠ è½½ä¿å­˜çš„ä¸»é¢˜
      (function() {
        const savedTheme = localStorage.getItem('chat-theme') || 'white';
        document.documentElement.setAttribute('data-theme', savedTheme);
      })();
      
      // ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½
      const themeToggleBtn = document.getElementById('theme-toggle-btn');
      const themePanel = document.getElementById('theme-panel');
      
      if (themeToggleBtn && themePanel) {
        themeToggleBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          themePanel.style.display = themePanel.style.display === 'flex' ? 'none' : 'flex';
        });
        
        // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­ä¸»é¢˜é¢æ¿
        document.addEventListener('click', function(e) {
          if (!themePanel.contains(e.target) && !themeToggleBtn.contains(e.target)) {
            themePanel.style.display = 'none';
          }
        });
        
        // é€‰æ‹©ä¸»é¢˜
        document.querySelectorAll('.theme-option').forEach(option => {
          option.addEventListener('click', function(e) {
            e.stopPropagation();
            const theme = this.getAttribute('data-theme');
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('chat-theme', theme);
            themePanel.style.display = 'none';
          });
        });
      }
      
      // ä¸åç«¯å»ºç«‹ Socket.IO è¿æ¥
      const socket = io({
        transports: ["websocket"]
      });

      // è®¾ç½®å½“å‰ç”¨æˆ·
      const currentUsername = "{{ username }}";

      // å­˜å‚¨å½“å‰é€‰æ‹©çš„æˆ¿é—´å’Œç§èŠå¯¹è±¡
      let currentRoom = 'general';
      let currentPrivateChat = null;
      const historyTypeSelect = document.getElementById('history-type-select');
      const historyRoomGroup = document.getElementById('history-room-group');
      const historyRoomSelect = document.getElementById('history-room-select');
      const historyPartnerGroup = document.getElementById('history-partner-group');
      const historyPartnerSelect = document.getElementById('history-partner-select');
      const historySearchInput = document.getElementById('history-search-input');
      const historyListEl = document.getElementById('history-list');
      const historyRefreshBtn = document.getElementById('history-refresh-btn');
      const historyState = {
        type: 'room',
        searchTimer: null
      };

      // è®¾ç½®å½“å‰æˆ¿é—´å¹¶è·³è½¬åˆ°èŠå¤©é¡µé¢
      function setCurrentRoom(roomName) {
        sessionStorage.setItem('currentRoom', roomName);
        sessionStorage.removeItem('privateChat');
      }

      // å¼€å§‹ç§äººèŠå¤©å¹¶è·³è½¬åˆ°èŠå¤©é¡µé¢
      function startPrivateChat(username) {
        sessionStorage.setItem('privateChat', username);
        sessionStorage.removeItem('currentRoom');
      }

      // åŠ å…¥èŠå¤©å®¤
      function joinRoom(roomName) {
        socket.emit('join_room', { room_name: roomName });
        
        // è®°å½•åŠ å…¥æˆåŠŸæ¶ˆæ¯ï¼ˆä¸å†æ˜¾ç¤ºå¼¹çª—ï¼‰
        console.log(`å·²åŠ å…¥èŠå¤©å®¤: ${roomName}`);
        
        // åˆ·æ–°é¡µé¢ä»¥æ›´æ–°çŠ¶æ€
        setTimeout(() => {
          window.location.reload();
        }, 1000);
      }

      // æ¨¡æ€æ¡†æ§åˆ¶
      function setupModal(modalId, openBtnId) {
        const modal = document.getElementById(modalId);
        const openBtn = document.getElementById(openBtnId);
        const closeBtn = modal.querySelector('.modal-close');

        openBtn.addEventListener('click', function() {
          modal.style.display = 'flex';
          // å¦‚æœæ˜¯ç®¡ç†èŠå¤©å®¤æ¨¡æ€æ¡†ï¼ŒåŠ è½½ç”¨æˆ·åˆ›å»ºçš„èŠå¤©å®¤
          if (modalId === 'manage-rooms-modal') {
            socket.emit('get_user_created_rooms');
          }
        });

        closeBtn.addEventListener('click', function() {
          modal.style.display = 'none';
        });

        window.addEventListener('click', function(event) {
          if (event.target === modal) {
            modal.style.display = 'none';
          }
        });
      }

      // åˆå§‹åŒ–æ¨¡æ€æ¡†
      setupModal('create-room-modal', 'create-room-btn');
      setupModal('join-by-token-modal', 'join-by-token-btn');
      setupModal('manage-rooms-modal', 'manage-rooms-btn');

      // åˆ›å»ºèŠå¤©å®¤è¡¨å•æäº¤
      document.getElementById('create-room-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const roomName = document.getElementById('room-name-input').value.trim();
        const roomType = document.querySelector('#create-room-form input[name="room-type"]:checked').value;
        
        if (roomName) {
          socket.emit('create_room_with_type', { 
            room_name: roomName, 
            room_type: roomType 
          });
          document.getElementById('room-name-input').value = '';
          document.getElementById('create-room-modal').style.display = 'none';
        }
      });

      // é€šè¿‡TokenåŠ å…¥èŠå¤©å®¤è¡¨å•æäº¤
      document.getElementById('join-by-token-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const token = document.getElementById('token-input').value.trim();
        if (token) {
          socket.emit('join_room_by_token', { token: token });
          document.getElementById('token-input').value = '';
          document.getElementById('join-by-token-modal').style.display = 'none';
        }
      });


      // Socket.IO äº‹ä»¶å¤„ç†
      socket.on("system_message", function (data) {
        console.log("ç³»ç»Ÿæ¶ˆæ¯:", data.text);
        // ä¸å†æ˜¾ç¤ºå¼¹çª—ï¼Œåªåœ¨æ§åˆ¶å°è®°å½•
      });

      socket.on("chat_rooms_list", function (rooms) {
        console.log("èŠå¤©å®¤åˆ—è¡¨å·²æ›´æ–°");
      });

      socket.on("user_rooms_list", function (rooms) {
        console.log("ç”¨æˆ·èŠå¤©å®¤åˆ—è¡¨å·²æ›´æ–°");
      });

      // å¤„ç†ç”¨æˆ·åˆ›å»ºçš„èŠå¤©å®¤åˆ—è¡¨
      socket.on("user_created_rooms", function (data) {
        const roomsList = document.getElementById('my-created-rooms-list');
        roomsList.innerHTML = '';

        if (data.rooms && data.rooms.length > 0) {
          data.rooms.forEach(room => {
            const roomItem = document.createElement('div');
            roomItem.className = 'room-item';
            roomItem.innerHTML = `
              <div class="room-info">
                <div class="room-name">${room.name}</div>
                <div class="room-meta">
                  ç±»å‹: ${room.room_type === 'private' ? 'ç§æœ‰' : 'å…¬å…±'} 
                  ${room.room_type === 'private' ? `(Token: ${room.token})` : ''}
                </div>
              </div>
              <button class="action-btn" onclick="deleteRoom('${room.name}')">è§£æ•£</button>
            `;
            roomsList.appendChild(roomItem);
          });
        } else {
          roomsList.innerHTML = '<div class="empty-state">æ‚¨è¿˜æ²¡æœ‰åˆ›å»ºä»»ä½•èŠå¤©å®¤</div>';
        }
      });

      // è§£æ•£èŠå¤©å®¤å‡½æ•°
      function deleteRoom(roomName) {
        // ç›´æ¥è§£æ•£èŠå¤©å®¤ï¼Œä¸å†æ˜¾ç¤ºç¡®è®¤å¼¹çª—
        socket.emit('delete_chat_room', { room_name: roomName });
      }

      // å¤„ç†é€šè¿‡TokenåŠ å…¥èŠå¤©å®¤çš„ç»“æœ
      socket.on("join_by_token_result", function (data) {
        if (data.success) {
          console.log(`æˆåŠŸåŠ å…¥èŠå¤©å®¤: ${data.room_name}`);
          setTimeout(() => {
            window.location.reload();
          }, 1000);
        } else {
          console.log(data.error || 'åŠ å…¥èŠå¤©å®¤å¤±è´¥');
        }
      });

      // å¤„ç†åˆ›å»ºèŠå¤©å®¤çš„ç»“æœ
      socket.on("room_created", function (data) {
        if (data.success) {
          if (data.room_type === 'private') {
            console.log(`ç§æœ‰èŠå¤©å®¤åˆ›å»ºæˆåŠŸï¼Token: ${data.token}`);
          } else {
            console.log('å…¬å…±èŠå¤©å®¤åˆ›å»ºæˆåŠŸï¼');
          }
          setTimeout(() => {
            window.location.reload();
          }, 1000);
        } else {
          console.log(data.error || 'åˆ›å»ºèŠå¤©å®¤å¤±è´¥');
        }
      });

      // å¤„ç†è§£æ•£èŠå¤©å®¤çš„ç»“æœ
      socket.on("room_deleted", function (data) {
        if (data.success) {
          console.log('èŠå¤©å®¤å·²æˆåŠŸè§£æ•£');
          socket.emit('get_user_created_rooms');
          setTimeout(() => {
            window.location.reload();
          }, 1000);
        } else {
          console.log(data.error || 'è§£æ•£èŠå¤©å®¤å¤±è´¥');
        }
      });

      function toggleHistoryFilters() {
        if (!historyRoomGroup || !historyPartnerGroup) return;
        if (historyState.type === 'private') {
          historyRoomGroup.style.display = 'none';
          historyPartnerGroup.style.display = 'flex';
        } else {
          historyRoomGroup.style.display = 'flex';
          historyPartnerGroup.style.display = 'none';
        }
      }

      function renderHistoryMessages(messages = []) {
        if (!historyListEl) return;
        if (!messages.length) {
          historyListEl.innerHTML = '<div class=\"history-empty\">æš‚æ— èŠå¤©è®°å½•</div>';
          return;
        }
        historyListEl.innerHTML = '';
        messages.forEach(msg => {
          const item = document.createElement('div');
          item.className = 'history-item';
          const resolvedType = msg.type || historyState.type;
          if (msg.id) {
            item.dataset.messageId = msg.id;
            item.dataset.messageType = resolvedType;
          }

          const title = document.createElement('strong');
          if (resolvedType === 'private') {
            title.textContent = `ç§äººæ¶ˆæ¯ â€¢ ${msg.partner || 'æœªçŸ¥è”ç³»äºº'}`;
          } else {
            title.textContent = `èŠå¤©å®¤ â€¢ ${msg.room || 'æœªçŸ¥æˆ¿é—´'}`;
          }

          const meta = document.createElement('div');
          meta.className = 'history-meta';
          meta.textContent = msg.timestamp || msg.time || '';

          const body = document.createElement('div');
          body.className = 'history-text';
          body.textContent = msg.text || '';

          item.appendChild(title);
          item.appendChild(meta);
          item.appendChild(body);

          if (msg.id) {
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'history-delete-btn';
            deleteBtn.type = 'button';
            deleteBtn.dataset.messageId = msg.id;
            deleteBtn.dataset.messageType = resolvedType;
            deleteBtn.textContent = 'åˆ é™¤';
            item.appendChild(deleteBtn);
          }

          historyListEl.appendChild(item);
        });
      }

      async function loadHistoryMessages() {
        if (!historyListEl || !historyTypeSelect) return;
        const params = new URLSearchParams({
          type: historyState.type,
          limit: 100
        });
        if (historyState.type === 'room' && historyRoomSelect && historyRoomSelect.value) {
          params.append('room', historyRoomSelect.value);
        }
        if (historyState.type === 'private' && historyPartnerSelect && historyPartnerSelect.value) {
          params.append('partner', historyPartnerSelect.value);
        }
        if (historySearchInput && historySearchInput.value.trim()) {
          params.append('q', historySearchInput.value.trim());
        }

        historyListEl.innerHTML = '<div class=\"history-loading\">åŠ è½½ä¸­...</div>';
        try {
          const response = await fetch(`/api/my-messages?${params.toString()}`);
          const result = await response.json();
          if (!result.success) {
            historyListEl.innerHTML = `<div class=\"history-empty\">${result.error || 'åŠ è½½å¤±è´¥'}</div>`;
            return;
          }
          renderHistoryMessages(result.messages || []);
        } catch (error) {
          console.error('åŠ è½½èŠå¤©è®°å½•å¤±è´¥', error);
          historyListEl.innerHTML = '<div class=\"history-empty\">åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>';
        }
      }

      async function deleteHistoryMessage(messageId, messageType = 'room') {
        if (!messageId) return false;
        try {
          const response = await fetch(`/api/my-messages/${messageId}?type=${messageType}`, {
            method: 'DELETE'
          });
          const result = await response.json();
          if (!result.success) {
            console.warn(result.error || 'åˆ é™¤èŠå¤©è®°å½•å¤±è´¥');
            return false;
          }
          return true;
        } catch (error) {
          console.error('åˆ é™¤èŠå¤©è®°å½•å¤±è´¥', error);
          return false;
        }
      }

      if (historyTypeSelect) {
        historyTypeSelect.addEventListener('change', () => {
          historyState.type = historyTypeSelect.value;
          toggleHistoryFilters();
          loadHistoryMessages();
        });
      }

      if (historyRoomSelect) {
        historyRoomSelect.addEventListener('change', loadHistoryMessages);
      }

      if (historyPartnerSelect) {
        historyPartnerSelect.addEventListener('change', loadHistoryMessages);
      }

      if (historyRefreshBtn) {
        historyRefreshBtn.addEventListener('click', loadHistoryMessages);
      }

      if (historySearchInput) {
        historySearchInput.addEventListener('input', () => {
          clearTimeout(historyState.searchTimer);
          historyState.searchTimer = setTimeout(loadHistoryMessages, 400);
        });
      }

      if (historyListEl) {
        historyListEl.addEventListener('click', async (event) => {
          const btn = event.target.closest('.history-delete-btn');
          if (!btn) return;
          const messageId = btn.dataset.messageId;
          const messageType = btn.dataset.messageType || historyState.type;
          const success = await deleteHistoryMessage(messageId, messageType);
          if (success) {
            const historyItem = btn.closest('.history-item');
            if (historyItem) {
              historyItem.remove();
            }
            if (!historyListEl.querySelector('.history-item')) {
              historyListEl.innerHTML = '<div class=\"history-empty\">æš‚æ— èŠå¤©è®°å½•</div>';
            }
          }
        });
      }

      if (historyListEl) {
        toggleHistoryFilters();
        loadHistoryMessages();
      }
    </script>
  </body>
</html>
