<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <title>èŠå¤©ä»ªè¡¨ç›˜ - å®‰å…¨é€šè®¯ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <style>
      .dashboard-layout {
        min-height: 100vh;
        background: var(--background-gradient);
        padding: 1rem;
      }
      
      .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        padding: 1rem 0;
      }
      
      .dashboard-title {
        font-size: 1.75rem;
        font-weight: 700;
        color: white;
        margin: 0;
      }
      
      .user-info {
        display: flex;
        align-items: center;
        gap: 1rem;
        color: white;
      }
      
      .logout-btn {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        text-decoration: none;
        transition: var(--transition);
        border: 1px solid rgba(255, 255, 255, 0.3);
      }
      
      .logout-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-1px);
      }
      
      .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
        gap: 2rem;
        margin-bottom: 2rem;
      }
      
      .dashboard-card {
        background: var(--card-bg);
        backdrop-filter: blur(20px);
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-xl);
        border: 1px solid var(--card-border);
        padding: 1.75rem;
        transition: var(--transition);
        position: relative;
        overflow: hidden;
      }
      
      .dashboard-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: linear-gradient(to bottom, var(--primary-color), var(--secondary-color));
      }
      
      .dashboard-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-xl), 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      }
      
      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid rgba(0, 0, 0, 0.08);
      }
      
      .card-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-primary);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }
      
      .card-title::before {
        content: '';
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: var(--primary-color);
      }
      
      .quick-actions {
        display: flex;
        gap: 0.5rem;
      }
      
      .action-btn {
        background: var(--primary-color);
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-size: 0.75rem;
        cursor: pointer;
        transition: var(--transition);
        font-weight: 600;
        box-shadow: var(--shadow-sm);
      }
      
      .action-btn:hover {
        background: var(--primary-hover);
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
      }
      
      .room-list, .user-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }
      
      .room-item, .user-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.7);
        border-radius: 12px;
        border: 1px solid rgba(0, 0, 0, 0.08);
        transition: var(--transition);
      }
      
      .room-item:hover, .user-item:hover {
        background: rgba(255, 255, 255, 0.9);
        transform: translateX(4px);
        box-shadow: var(--shadow-sm);
      }
      
      .room-info, .user-info-compact {
        flex: 1;
      }
      
      .room-name, .user-name {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.25rem;
        font-size: 0.9rem;
      }
      
      .room-meta, .user-meta {
        font-size: 0.7rem;
        color: var(--text-secondary);
        opacity: 0.8;
      }
      
      .enter-btn, .join-btn, .chat-btn {
        background: var(--primary-color);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        text-decoration: none;
        font-size: 0.75rem;
        transition: var(--transition);
        border: none;
        cursor: pointer;
        font-weight: 600;
        box-shadow: var(--shadow-sm);
      }
      
      .enter-btn:hover, .join-btn:hover, .chat-btn:hover {
        background: var(--primary-hover);
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
      }
      
      .join-btn {
        background: var(--success-color);
      }
      
      .join-btn:hover {
        background: #0da271;
      }
      
      .user-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        margin-right: 0.75rem;
        font-size: 0.8rem;
        box-shadow: var(--shadow-sm);
      }
      
      .empty-state {
        text-align: center;
        padding: 2.5rem 1rem;
        color: var(--text-secondary);
        font-size: 0.9rem;
      }
      
      .empty-state::before {
        content: 'ğŸ“';
        font-size: 2rem;
        display: block;
        margin-bottom: 0.5rem;
        opacity: 0.5;
      }
      
      .create-room-section {
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 1px solid rgba(0, 0, 0, 0.08);
      }
      
      .create-room-btn {
        width: 100%;
        background: transparent;
        border: 2px dashed var(--primary-color);
        color: var(--primary-color);
        padding: 1rem;
        border-radius: 12px;
        cursor: pointer;
        transition: var(--transition);
        font-weight: 700;
        font-size: 0.9rem;
      }
      
      .create-room-btn:hover {
        background: var(--primary-color);
        color: white;
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
      }
      
      /* æ¨¡æ€æ¡†æ ·å¼ */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }
      
      .modal-content {
        background: var(--card-bg);
        backdrop-filter: blur(20px);
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-xl);
        border: 1px solid var(--card-border);
        padding: 2rem;
        max-width: 400px;
        width: 90%;
        position: relative;
      }
      
      .modal-close {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--text-secondary);
      }
      
      .modal-title {
        margin-bottom: 1.5rem;
        color: var(--text-primary);
      }
      
      .modal-form {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      
      .modal-input {
        padding: 0.75rem 1rem;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 0.875rem;
        transition: var(--transition);
      }
      
      .modal-input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
      }
      
      .modal-submit {
        background: var(--primary-color);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
      }
      
      .modal-submit:hover {
        background: var(--primary-hover);
        transform: translateY(-1px);
      }
      
      @media (max-width: 768px) {
        .dashboard-grid {
          grid-template-columns: 1fr;
        }
        
        .dashboard-header {
          flex-direction: column;
          gap: 1rem;
          text-align: center;
        }
        
        .room-item, .user-item {
          flex-direction: column;
          gap: 1rem;
          text-align: center;
        }
      }
    </style>
  </head>
  <body>
    <div class="dashboard-layout fade-in">
      <header class="dashboard-header">
        <h1 class="dashboard-title">å®‰å…¨é€šè®¯ç³»ç»Ÿ</h1>
        <div class="user-info">
          <span>æ¬¢è¿ï¼Œ{{ username }}ï¼</span>
          <a class="logout-btn" href="{{ url_for('logout') }}">é€€å‡ºç™»å½•</a>
        </div>
      </header>

      <div class="dashboard-grid">
        <!-- æˆ‘çš„èŠå¤©å®¤å¡ç‰‡ -->
        <div class="dashboard-card">
          <div class="card-header">
            <h2 class="card-title">æˆ‘çš„èŠå¤©å®¤</h2>
            <div class="quick-actions">
              <button class="action-btn" id="join-by-token-btn">é€šè¿‡TokenåŠ å…¥</button>
              <button class="action-btn" id="manage-rooms-btn">ç®¡ç†èŠå¤©å®¤</button>
            </div>
          </div>
          
          <div class="room-list">
            {% if user_rooms %}
              {% for room_name in user_rooms %}
                <div class="room-item">
                  <div class="room-info">
                    <div class="room-name">{{ room_name }}</div>
                    <div class="room-meta">å·²åŠ å…¥çš„èŠå¤©å®¤</div>
                  </div>
                  <a href="{{ url_for('chat') }}" class="enter-btn" onclick="setCurrentRoom('{{ room_name }}')">è¿›å…¥</a>
                </div>
              {% endfor %}
            {% else %}
              <div class="empty-state">æ‚¨è¿˜æ²¡æœ‰åŠ å…¥ä»»ä½•èŠå¤©å®¤</div>
            {% endif %}
          </div>
          
          <div class="create-room-section">
            <button class="create-room-btn" id="create-room-btn">+ åˆ›å»ºèŠå¤©å®¤</button>
          </div>
        </div>

        <!-- å…¬å…±èŠå¤©å®¤å¡ç‰‡ -->
        <div class="dashboard-card">
          <div class="card-header">
            <h2 class="card-title">å…¬å…±èŠå¤©å®¤</h2>
          </div>
          
          <div class="room-list">
            {% if public_rooms %}
              {% for room in public_rooms %}
                <div class="room-item">
                  <div class="room-info">
                    <div class="room-name">{{ room.name }}</div>
                    <div class="room-meta">
                      åˆ›å»ºè€…: {{ room.created_by }}
                      <br>
                      <small>åˆ›å»ºæ—¶é—´: {{ room.created_at }}</small>
                    </div>
                  </div>
                  {% if room.name in user_rooms %}
                    <a href="{{ url_for('chat') }}" class="enter-btn" onclick="setCurrentRoom('{{ room.name }}')">è¿›å…¥</a>
                  {% else %}
                    <button class="join-btn" onclick="joinRoom('{{ room.name }}')">åŠ å…¥</button>
                  {% endif %}
                </div>
              {% endfor %}
            {% else %}
              <div class="empty-state">æš‚æ— å…¬å…±èŠå¤©å®¤</div>
            {% endif %}
          </div>
        </div>

        <!-- ç”¨æˆ·åˆ—è¡¨å¡ç‰‡ -->
        <div class="dashboard-card">
          <div class="card-header">
            <h2 class="card-title">æ‰€æœ‰ç”¨æˆ·</h2>
          </div>
          
          <div class="user-list">
            {% if other_users %}
              {% for user in other_users %}
                <div class="user-item">
                  <div class="user-info-compact" style="display: flex; align-items: center;">
                    <div class="user-avatar">{{ user[0]|upper }}</div>
                    <div>
                      <div class="user-name">{{ user }}</div>
                      <div class="user-meta">åœ¨çº¿ç”¨æˆ·</div>
                    </div>
                  </div>
                  <a href="{{ url_for('chat') }}" class="chat-btn" onclick="startPrivateChat('{{ user }}')">ç§èŠ</a>
                </div>
              {% endfor %}
            {% else %}
              <div class="empty-state">æš‚æ— å…¶ä»–ç”¨æˆ·</div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- æ¨¡æ€æ¡† -->
    <div id="create-room-modal" class="modal">
      <div class="modal-content">
        <button class="modal-close">&times;</button>
        <h3 class="modal-title">åˆ›å»ºæ–°èŠå¤©å®¤</h3>
        <form class="modal-form" id="create-room-form">
          <input type="text" class="modal-input" id="room-name-input" placeholder="è¾“å…¥èŠå¤©å®¤åç§°" required>
          <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
            <label style="display: flex; align-items: center; gap: 0.5rem;">
              <input type="radio" name="room-type" value="public" checked>
              å…¬å…±èŠå¤©å®¤
            </label>
            <label style="display: flex; align-items: center; gap: 0.5rem;">
              <input type="radio" name="room-type" value="private">
              ç§æœ‰èŠå¤©å®¤
            </label>
          </div>
          <button type="submit" class="modal-submit">åˆ›å»º</button>
        </form>
      </div>
    </div>

    <div id="join-by-token-modal" class="modal">
      <div class="modal-content">
        <button class="modal-close">&times;</button>
        <h3 class="modal-title">é€šè¿‡TokenåŠ å…¥èŠå¤©å®¤</h3>
        <form class="modal-form" id="join-by-token-form">
          <input type="text" class="modal-input" id="token-input" placeholder="è¾“å…¥èŠå¤©å®¤Token" required>
          <button type="submit" class="modal-submit">åŠ å…¥</button>
        </form>
      </div>
    </div>

    <div id="manage-rooms-modal" class="modal">
      <div class="modal-content">
        <button class="modal-close">&times;</button>
        <h3 class="modal-title">ç®¡ç†æˆ‘çš„èŠå¤©å®¤</h3>
        
        <div class="create-room-section">
          <h4>æˆ‘åˆ›å»ºçš„èŠå¤©å®¤</h4>
          <div id="my-created-rooms-list" class="room-list">
            <!-- åŠ¨æ€åŠ è½½çš„èŠå¤©å®¤åˆ—è¡¨ -->
          </div>
        </div>
      </div>
    </div>

    <!-- Socket.IO å®¢æˆ·ç«¯ -->
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
      // ä¸åç«¯å»ºç«‹ Socket.IO è¿æ¥
      const socket = io({
        transports: ["websocket"]
      });

      // è®¾ç½®å½“å‰ç”¨æˆ·
      const currentUsername = "{{ username }}";

      // å­˜å‚¨å½“å‰é€‰æ‹©çš„æˆ¿é—´å’Œç§èŠå¯¹è±¡
      let currentRoom = 'general';
      let currentPrivateChat = null;

      // è®¾ç½®å½“å‰æˆ¿é—´å¹¶è·³è½¬åˆ°èŠå¤©é¡µé¢
      function setCurrentRoom(roomName) {
        sessionStorage.setItem('currentRoom', roomName);
        sessionStorage.removeItem('privateChat');
      }

      // å¼€å§‹ç§äººèŠå¤©å¹¶è·³è½¬åˆ°èŠå¤©é¡µé¢
      function startPrivateChat(username) {
        sessionStorage.setItem('privateChat', username);
        sessionStorage.removeItem('currentRoom');
      }

      // åŠ å…¥èŠå¤©å®¤
      function joinRoom(roomName) {
        socket.emit('join_room', { room_name: roomName });
        
        // è®°å½•åŠ å…¥æˆåŠŸæ¶ˆæ¯ï¼ˆä¸å†æ˜¾ç¤ºå¼¹çª—ï¼‰
        console.log(`å·²åŠ å…¥èŠå¤©å®¤: ${roomName}`);
        
        // åˆ·æ–°é¡µé¢ä»¥æ›´æ–°çŠ¶æ€
        setTimeout(() => {
          window.location.reload();
        }, 1000);
      }

      // æ¨¡æ€æ¡†æ§åˆ¶
      function setupModal(modalId, openBtnId) {
        const modal = document.getElementById(modalId);
        const openBtn = document.getElementById(openBtnId);
        const closeBtn = modal.querySelector('.modal-close');

        openBtn.addEventListener('click', function() {
          modal.style.display = 'flex';
          // å¦‚æœæ˜¯ç®¡ç†èŠå¤©å®¤æ¨¡æ€æ¡†ï¼ŒåŠ è½½ç”¨æˆ·åˆ›å»ºçš„èŠå¤©å®¤
          if (modalId === 'manage-rooms-modal') {
            socket.emit('get_user_created_rooms');
          }
        });

        closeBtn.addEventListener('click', function() {
          modal.style.display = 'none';
        });

        window.addEventListener('click', function(event) {
          if (event.target === modal) {
            modal.style.display = 'none';
          }
        });
      }

      // åˆå§‹åŒ–æ¨¡æ€æ¡†
      setupModal('create-room-modal', 'create-room-btn');
      setupModal('join-by-token-modal', 'join-by-token-btn');
      setupModal('manage-rooms-modal', 'manage-rooms-btn');

      // åˆ›å»ºèŠå¤©å®¤è¡¨å•æäº¤
      document.getElementById('create-room-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const roomName = document.getElementById('room-name-input').value.trim();
        const roomType = document.querySelector('#create-room-form input[name="room-type"]:checked').value;
        
        if (roomName) {
          socket.emit('create_room_with_type', { 
            room_name: roomName, 
            room_type: roomType 
          });
          document.getElementById('room-name-input').value = '';
          document.getElementById('create-room-modal').style.display = 'none';
        }
      });

      // é€šè¿‡TokenåŠ å…¥èŠå¤©å®¤è¡¨å•æäº¤
      document.getElementById('join-by-token-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const token = document.getElementById('token-input').value.trim();
        if (token) {
          socket.emit('join_room_by_token', { token: token });
          document.getElementById('token-input').value = '';
          document.getElementById('join-by-token-modal').style.display = 'none';
        }
      });


      // Socket.IO äº‹ä»¶å¤„ç†
      socket.on("system_message", function (data) {
        console.log("ç³»ç»Ÿæ¶ˆæ¯:", data.text);
        // ä¸å†æ˜¾ç¤ºå¼¹çª—ï¼Œåªåœ¨æ§åˆ¶å°è®°å½•
      });

      socket.on("chat_rooms_list", function (rooms) {
        console.log("èŠå¤©å®¤åˆ—è¡¨å·²æ›´æ–°");
      });

      socket.on("user_rooms_list", function (rooms) {
        console.log("ç”¨æˆ·èŠå¤©å®¤åˆ—è¡¨å·²æ›´æ–°");
      });

      // å¤„ç†ç”¨æˆ·åˆ›å»ºçš„èŠå¤©å®¤åˆ—è¡¨
      socket.on("user_created_rooms", function (data) {
        const roomsList = document.getElementById('my-created-rooms-list');
        roomsList.innerHTML = '';

        if (data.rooms && data.rooms.length > 0) {
          data.rooms.forEach(room => {
            const roomItem = document.createElement('div');
            roomItem.className = 'room-item';
            roomItem.innerHTML = `
              <div class="room-info">
                <div class="room-name">${room.name}</div>
                <div class="room-meta">
                  ç±»å‹: ${room.room_type === 'private' ? 'ç§æœ‰' : 'å…¬å…±'} 
                  ${room.room_type === 'private' ? `(Token: ${room.token})` : ''}
                </div>
              </div>
              <button class="action-btn" onclick="deleteRoom('${room.name}')">è§£æ•£</button>
            `;
            roomsList.appendChild(roomItem);
          });
        } else {
          roomsList.innerHTML = '<div class="empty-state">æ‚¨è¿˜æ²¡æœ‰åˆ›å»ºä»»ä½•èŠå¤©å®¤</div>';
        }
      });

      // è§£æ•£èŠå¤©å®¤å‡½æ•°
      function deleteRoom(roomName) {
        // ç›´æ¥è§£æ•£èŠå¤©å®¤ï¼Œä¸å†æ˜¾ç¤ºç¡®è®¤å¼¹çª—
        socket.emit('delete_chat_room', { room_name: roomName });
      }

      // å¤„ç†é€šè¿‡TokenåŠ å…¥èŠå¤©å®¤çš„ç»“æœ
      socket.on("join_by_token_result", function (data) {
        if (data.success) {
          console.log(`æˆåŠŸåŠ å…¥èŠå¤©å®¤: ${data.room_name}`);
          setTimeout(() => {
            window.location.reload();
          }, 1000);
        } else {
          console.log(data.error || 'åŠ å…¥èŠå¤©å®¤å¤±è´¥');
        }
      });

      // å¤„ç†åˆ›å»ºèŠå¤©å®¤çš„ç»“æœ
      socket.on("room_created", function (data) {
        if (data.success) {
          if (data.room_type === 'private') {
            console.log(`ç§æœ‰èŠå¤©å®¤åˆ›å»ºæˆåŠŸï¼Token: ${data.token}`);
          } else {
            console.log('å…¬å…±èŠå¤©å®¤åˆ›å»ºæˆåŠŸï¼');
          }
          setTimeout(() => {
            window.location.reload();
          }, 1000);
        } else {
          console.log(data.error || 'åˆ›å»ºèŠå¤©å®¤å¤±è´¥');
        }
      });

      // å¤„ç†è§£æ•£èŠå¤©å®¤çš„ç»“æœ
      socket.on("room_deleted", function (data) {
        if (data.success) {
          console.log('èŠå¤©å®¤å·²æˆåŠŸè§£æ•£');
          socket.emit('get_user_created_rooms');
          setTimeout(() => {
            window.location.reload();
          }, 1000);
        } else {
          console.log(data.error || 'è§£æ•£èŠå¤©å®¤å¤±è´¥');
        }
      });
    </script>
  </body>
</html>
